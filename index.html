<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TerriTory</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=JetBrains+Mono:wght@400;700&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:#060810;color:#e2e8f5}

/* â”€â”€ LOADING â”€â”€â”€ */
#loading{position:fixed;inset:0;background:#060810;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.spin{width:36px;height:36px;border:3px solid rgba(56,189,248,0.15);border-top-color:#38bdf8;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loadtxt{font-family:'JetBrains Mono',monospace;font-size:12px;color:#4a5568;letter-spacing:2px}



/* â”€â”€ AUTH â”€â”€â”€ */
#auth{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#060810;z-index:999}
.card{background:#0d1017;border:1px solid rgba(56,189,248,0.22);border-radius:22px;padding:38px 34px;width:420px;max-width:94vw;box-shadow:0 0 60px rgba(56,189,248,0.06),0 24px 48px rgba(0,0,0,0.6)}
.logo{font-family:'Syne',sans-serif;font-size:42px;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,#38bdf8,#818cf8,#e879f9);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:3px}
.sub{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:3px;color:#4a5568;margin-bottom:28px;text-transform:uppercase}
.tabs{display:flex;background:rgba(255,255,255,0.05);border-radius:10px;padding:3px;margin-bottom:22px;gap:3px}
.tab{flex:1;padding:10px;border:none;background:none;color:#4a5568;font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;border-radius:8px;cursor:pointer;transition:all .2s}
.tab.on{background:rgba(56,189,248,0.14);color:#38bdf8}
.lbl{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#4a5568;display:block;margin-bottom:7px}
.inp{width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:11px;padding:12px 14px;color:#e2e8f5;font-family:'Outfit',sans-serif;font-size:15px;outline:none;margin-bottom:14px;transition:border-color .2s}
.inp:focus{border-color:rgba(56,189,248,0.5)}
.swatches{display:flex;gap:9px;flex-wrap:wrap;margin-bottom:22px}
.sw{width:36px;height:36px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:transform .15s;position:relative}
.sw:hover{transform:scale(1.1)}
.sw.sel{border-color:#fff;transform:scale(1.12)}
.sw.sel::after{content:'âœ“';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:rgba(0,0,0,0.75)}
.abtn{width:100%;padding:13px;background:linear-gradient(135deg,#38bdf8,#818cf8);color:#000;border:none;border-radius:12px;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;letter-spacing:.5px;cursor:pointer;transition:opacity .2s}
.abtn:hover{opacity:.88}
.abtn:disabled{opacity:.5;cursor:not-allowed}
.err{color:#f87171;font-family:'JetBrains Mono',monospace;font-size:12px;margin-top:8px;min-height:16px;text-align:center}
.ulist{display:flex;flex-direction:column;gap:8px;max-height:190px;overflow-y:auto;margin-bottom:6px}
.urow{display:flex;align-items:center;gap:11px;padding:11px 13px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:11px;cursor:pointer;transition:all .15s}
.urow:hover{border-color:rgba(56,189,248,0.35);background:rgba(56,189,248,0.05)}
.av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#000;flex-shrink:0}
.uname{font-weight:600;font-size:14px}
.empty{text-align:center;color:#4a5568;font-family:'JetBrains Mono',monospace;font-size:12px;padding:20px}
.pwrap{position:relative}
.peye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:#4a5568;cursor:pointer;font-size:16px;padding:2px}

/* â”€â”€ APP â”€â”€â”€ */
#app{display:none;flex-direction:column;height:100vh}
.hdr{display:flex;align-items:center;gap:12px;padding:0 18px;height:54px;background:rgba(13,16,23,0.97);border-bottom:1px solid rgba(255,255,255,0.07);z-index:600;flex-shrink:0}
.hlogo{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;background:linear-gradient(135deg,#38bdf8,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hplayer{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:5px 12px 5px 7px;cursor:pointer;font-size:14px;font-weight:500;transition:border-color .2s;position:relative}
.hplayer:hover{border-color:rgba(56,189,248,0.35)}
.hav{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#000;flex-shrink:0}
.syncing{font-family:'JetBrains Mono',monospace;font-size:10px;color:#4a5568;letter-spacing:1px}
.syncing.ok{color:#4ade80}.syncing.err{color:#f87171}
.gpsbadge{margin-left:auto;display:flex;align-items:center;gap:6px;font-family:'JetBrains Mono',monospace;font-size:11px;padding:5px 11px;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);color:#4a5568}
.gpsbadge.live{color:#4ade80;border-color:rgba(74,222,128,0.25);background:rgba(74,222,128,0.07)}
.gpsbadge.weak{color:#fbbf24;border-color:rgba(251,191,36,0.25);background:rgba(251,191,36,0.06)}
.gdot{width:7px;height:7px;border-radius:50%;background:currentColor;flex-shrink:0}
.gpsbadge.live .gdot{animation:gp 1.4s ease-in-out infinite}
@keyframes gp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.6)}}
.layout{display:flex;flex:1;overflow:hidden}
#map{flex:1;position:relative}
.sidebar{width:280px;background:#0d1017;border-left:1px solid rgba(255,255,255,0.07);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
.sbscroll{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.07) transparent}
.sbs{padding:16px;border-bottom:1px solid rgba(255,255,255,0.07)}
.sbt{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:#4a5568;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.sbt-tag{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(56,189,248,0.1);color:#38bdf8;letter-spacing:1px}
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sc{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:13px 11px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:2px 2px 0 0}
.sc.c1::before{background:linear-gradient(90deg,#38bdf8,#818cf8)}
.sc.c2::before{background:linear-gradient(90deg,#4ade80,#22d3ee)}
.sc.c3::before{background:linear-gradient(90deg,#fb923c,#f472b6)}
.sc.c4::before{background:linear-gradient(90deg,#818cf8,#e879f9)}
.sc.c5::before{background:linear-gradient(90deg,#fbbf24,#f87171)}
.sc.c6::before{background:linear-gradient(90deg,#34d399,#38bdf8)}
.sv{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;line-height:1;margin-bottom:4px}
.sl{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:#4a5568;font-weight:600}
.si{position:absolute;top:11px;right:9px;font-size:15px;opacity:.22}
.btrack{height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;margin-top:6px}
.bfill{height:100%;border-radius:3px;background:linear-gradient(90deg,#38bdf8,#818cf8);transition:width .5s ease}
.lbrow{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:9px;transition:background .15s;margin-bottom:2px}
.lbrow.me{background:rgba(56,189,248,0.06);border:1px solid rgba(56,189,248,0.12)}
.lbrank{font-family:'JetBrains Mono',monospace;font-size:11px;color:#4a5568;width:18px;text-align:center;flex-shrink:0}
.lbav{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#000;flex-shrink:0}
.lbn{flex:1;font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lbs{font-family:'JetBrains Mono',monospace;font-size:11px;padding:2px 7px;border-radius:5px;background:rgba(255,255,255,0.05);color:#4a5568;flex-shrink:0}
.hist-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px;font-size:12px;margin-bottom:3px;background:rgba(255,255,255,0.02)}
.hist-date{font-family:'JetBrains Mono',monospace;color:#4a5568;font-size:11px}
.hist-vals{display:flex;gap:10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:#94a3b8}
.mctrl{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:500}
.mb{background:rgba(13,16,23,0.93);border:1px solid rgba(255,255,255,0.09);color:#e2e8f5;border-radius:13px;padding:11px 17px;font-family:'Outfit',sans-serif;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;backdrop-filter:blur(12px);box-shadow:0 6px 24px rgba(0,0,0,0.4);white-space:nowrap}
.mb:hover{border-color:rgba(56,189,248,0.4);color:#38bdf8}
.mb.go{background:linear-gradient(135deg,#38bdf8,#818cf8);color:#000;border:none;font-family:'Syne',sans-serif;font-size:14px}
.mb.go:hover{opacity:.9;color:#000}
.mb.stop{background:linear-gradient(135deg,#ef4444,#f97316);color:#000;border:none;font-family:'Syne',sans-serif}
.mb.stop:hover{opacity:.9;color:#000}
#pdd{position:absolute;top:54px;left:90px;background:rgba(10,12,18,0.98);border:1px solid rgba(56,189,248,0.15);border-radius:14px;padding:7px;z-index:800;display:none;min-width:190px;box-shadow:0 16px 48px rgba(0,0,0,0.6);backdrop-filter:blur(16px)}
#pdd.open{display:block}
.ddi{display:flex;align-items:center;gap:9px;padding:9px 11px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:background .15s}
.ddi:hover{background:rgba(255,255,255,0.05)}
.ddsep{height:1px;background:rgba(255,255,255,0.07);margin:5px 0}
.dda{display:flex;align-items:center;gap:9px;padding:8px 11px;border-radius:8px;cursor:pointer;font-size:12px;color:#4a5568;transition:all .15s;font-family:'JetBrains Mono',monospace}
.dda:hover{background:rgba(255,255,255,0.04);color:#e2e8f5}
#toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(10px);background:rgba(13,16,23,0.96);border:1px solid rgba(56,189,248,0.2);border-radius:11px;padding:10px 18px;font-size:13px;font-weight:500;z-index:9000;opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;white-space:nowrap;font-family:'JetBrains Mono',monospace;box-shadow:0 6px 24px rgba(0,0,0,0.4)}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
@keyframes cflash{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}30%{opacity:1;transform:translate(-50%,-50%) scale(1.05)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.2)}}
.cpop{position:fixed;top:50%;left:50%;font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:2px;pointer-events:none;z-index:9000;text-shadow:0 0 30px currentColor;animation:cflash 1.4s ease forwards}

/* â”€â”€ LOOP CELEBRATION â”€â”€â”€ */
.loop-celebrate{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9001;pointer-events:none;text-align:center;animation:loopPop 2.5s ease forwards}
@keyframes loopPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.3)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}30%{transform:translate(-50%,-50%) scale(1)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-50%) scale(1.3)}}
.loop-celebrate .lc-title{font-family:'Syne',sans-serif;font-size:36px;font-weight:800;color:#fff;text-shadow:0 0 40px currentColor;margin-bottom:8px}
.loop-celebrate .lc-sub{font-family:'JetBrains Mono',monospace;font-size:13px;color:rgba(255,255,255,0.7);letter-spacing:2px}

/* â”€â”€ SPEED INDICATOR â”€â”€â”€ */
#speed-hud{position:absolute;top:70px;right:20px;z-index:500;background:rgba(13,16,23,0.9);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:12px 16px;text-align:center;display:none;backdrop-filter:blur(12px)}
.speed-val{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:#38bdf8;line-height:1}
.speed-unit{font-family:'JetBrains Mono',monospace;font-size:10px;color:#4a5568;letter-spacing:2px;text-transform:uppercase;margin-top:3px}
.speed-cadence{font-family:'JetBrains Mono',monospace;font-size:11px;color:#818cf8;margin-top:4px}

/* â”€â”€ TRAIL STATS HUD â”€â”€â”€ */
#trail-hud{position:absolute;top:70px;left:20px;z-index:500;background:rgba(13,16,23,0.9);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:10px 14px;display:none;backdrop-filter:blur(12px);min-width:140px}
.th-row{display:flex;justify-content:space-between;gap:16px;margin-bottom:6px}
.th-row:last-child{margin-bottom:0}
.th-label{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:#4a5568}
.th-val{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:#e2e8f5}

/* â”€â”€ LOOP CLOSE HINT â”€â”€â”€ */
#loop-hint{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);z-index:500;background:rgba(13,16,23,0.92);border:1px solid rgba(129,140,248,0.4);border-radius:10px;padding:8px 16px;font-family:'JetBrains Mono',monospace;font-size:11px;color:#818cf8;display:none;backdrop-filter:blur(8px);letter-spacing:1px;white-space:nowrap}

@media(max-width:700px){.sidebar{display:none}}
</style>
</head>
<body>

<div id="loading">
  <div class="spin"></div>
  <div class="loadtxt">CONNECTING TO SERVER...</div>
</div>



<div id="auth">
  <div class="card">
    <div class="logo">TerriTory</div>
    <div class="sub">Claim Â· Conquer Â· Dominate</div>
    <div class="tabs">
      <button class="tab on" id="tLogin">Sign In</button>
      <button class="tab" id="tRegister">Create Account</button>
    </div>
    <div id="pLogin">
      <div class="ulist" id="ulist"></div>
      <div style="margin-top:10px">
        <label class="lbl">Or enter username</label>
        <input class="inp" id="loginUser" placeholder="username" autocomplete="off">
        <label class="lbl">Password</label>
        <div class="pwrap">
          <input class="inp" id="loginPass" type="password" placeholder="password" style="margin-bottom:0;padding-right:40px">
          <button class="peye" onclick="togglePw('loginPass',this)">ğŸ‘</button>
        </div>
      </div>
      <button class="abtn" id="btnLogin" style="margin-top:14px">SIGN IN â†’</button>
      <div class="err" id="loginErr"></div>
    </div>
    <div id="pRegister" style="display:none">
      <label class="lbl">Username</label>
      <input class="inp" id="inUser" placeholder="e.g. shadow_walker" maxlength="20" autocomplete="off">
      <label class="lbl">Display Name</label>
      <input class="inp" id="inName" placeholder="Your name on the map" maxlength="16" autocomplete="off">
      <label class="lbl">Password</label>
      <div class="pwrap">
        <input class="inp" id="inPass" type="password" placeholder="choose a password" style="margin-bottom:14px;padding-right:40px">
        <button class="peye" onclick="togglePw('inPass',this)">ğŸ‘</button>
      </div>
      <label class="lbl">Territory Color</label>
      <div class="swatches" id="swatches"></div>
      <button class="abtn" id="btnCreate">CREATE ACCOUNT â†’</button>
      <div class="err" id="regErr"></div>
    </div>
  </div>
</div>

<div id="app">
  <div class="hdr">
    <div class="hlogo">TerriTory</div>
    <div class="hplayer" id="hplayer">
      <div class="hav" id="hav"></div>
      <span id="hname"></span>
      <span style="color:#4a5568;font-size:11px;margin-left:3px">â–¾</span>
    </div>
    <span class="syncing" id="syncStatus">SYNCING...</span>
    <div class="gpsbadge" id="gpsbadge">
      <div class="gdot"></div>
      <span id="gpstext">READY</span>
    </div>
  </div>
  <div id="pdd"></div>
  <div class="layout">
    <div id="map">
      <!-- Speed HUD -->
      <div id="speed-hud">
        <div class="speed-val" id="speedVal">0.0</div>
        <div class="speed-unit">km/h</div>
        <div class="speed-cadence" id="cadenceVal">â€” spm</div>
      </div>
      <!-- Trail Stats HUD -->
      <div id="trail-hud">
        <div class="th-row">
          <span class="th-label">Time</span>
          <span class="th-val" id="hudTime">00:00</span>
        </div>
        <div class="th-row">
          <span class="th-label">Pace</span>
          <span class="th-val" id="hudPace">â€”</span>
        </div>
        <div class="th-row">
          <span class="th-label">Loops</span>
          <span class="th-val" id="hudLoops">0</span>
        </div>
        <div class="th-row">
          <span class="th-label">Area</span>
          <span class="th-val" id="hudArea">0mÂ²</span>
        </div>
      </div>
      <!-- Loop Hint -->
      <div id="loop-hint">ğŸ” Close loop to claim territory!</div>
    </div>
    <div class="sidebar">
      <div class="sbscroll">
        <div class="sbs">
          <div class="sbt">Today's Stats <span class="sbt-tag">LIVE</span></div>
          <div class="sgrid">
            <div class="sc c1"><div class="si">ğŸ‘Ÿ</div><div class="sv" id="sSteps">0</div><div class="sl">Steps</div></div>
            <div class="sc c2"><div class="si">ğŸ“</div><div class="sv" id="sDist">0m</div><div class="sl">Distance</div></div>
            <div class="sc c3"><div class="si">ğŸ”¥</div><div class="sv" id="sCal">0</div><div class="sl">Calories</div></div>
            <div class="sc c4"><div class="si">ğŸ—ºï¸</div><div class="sv" id="sZones">0</div><div class="sl">Zones</div></div>
            <div class="sc c5"><div class="si">âš¡</div><div class="sv" id="sSpeed">0.0</div><div class="sl">km/h</div></div>
            <div class="sc c6"><div class="si">ğŸ”</div><div class="sv" id="sLoops">0</div><div class="sl">Loops</div></div>
          </div>
          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
              <span class="sl">Territory %</span>
              <span style="font-family:'JetBrains Mono',monospace;font-size:12px;color:#38bdf8" id="sPct">0%</span>
            </div>
            <div class="btrack"><div class="bfill" id="sBar" style="width:0%"></div></div>
          </div>
        </div>
        <div class="sbs">
          <div class="sbt">Leaderboard</div>
          <div id="lb"></div>
        </div>
        <div class="sbs">
          <div class="sbt">My History <span class="sbt-tag">7 DAYS</span></div>
          <div id="histList"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="mctrl">
    <button class="mb" id="btnCenter">ğŸ“ Center</button>
    <button class="mb go" id="btnTrack">â–¶ START</button>
    <button class="mb" id="btnReset" style="color:#f87171">â†º Reset</button>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG â€” hardcoded by admin, invisible to users
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SB_URL = 'https://zvcpyvhnaahxsnoqycfr.supabase.co';
var SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2Y3B5dmhuYWFoeHNub3F5Y2ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTE0NjMsImV4cCI6MjA4NzE2NzQ2M30.wHMNZfjyYTzWZg0JjQ0fFjNmx7pt-YdG5Kxy2fWk5D0';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sbUrl(path){ return SB_URL+'/rest/v1/'+path; }
function sbHeaders(extra){
  return Object.assign({'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY},extra||{});
}
async function sbSelect(table,query){
  var r=await fetch(sbUrl(table+'?'+query),{headers:sbHeaders({'Prefer':'return=representation'})});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbInsert(table,body){
  var r=await fetch(sbUrl(table),{method:'POST',headers:sbHeaders({'Prefer':'return=representation'}),body:JSON.stringify(body)});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbUpsert(table,body,onConflict){
  var url=sbUrl(table)+(onConflict?'?on_conflict='+onConflict:'');
  var r=await fetch(url,{method:'POST',headers:sbHeaders({'Prefer':'return=representation,resolution=merge-duplicates'}),body:JSON.stringify(body)});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbUpdate(table,query,body){
  var r=await fetch(sbUrl(table+'?'+query),{method:'PATCH',headers:sbHeaders({'Prefer':'return=representation'}),body:JSON.stringify(body)});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbDelete(table,query){
  var r=await fetch(sbUrl(table+'?'+query),{method:'DELETE',headers:sbHeaders()});
  if(!r.ok) throw new Error(await r.text());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PASSWORD HASH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function hashPw(pw){
  var buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(pw));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP COUNTING â€” PROPER PEDOMETER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
  Real step counting based on accelerometer (DeviceMotion API)
  Falls back to stride-based estimation from GPS if not available.
  
  Algorithm:
  1. Read accelerometer magnitude = sqrt(axÂ²+ayÂ²+azÂ²) - 9.8 (gravity-free)
  2. Low-pass filter to remove noise
  3. Count peaks above threshold with minimum time gap (debounce)
*/
var accelBuffer=[], stepLastTime=0, stepCount=0, accelAvg=0;
var STEP_THRESHOLD=1.2, STEP_MIN_INTERVAL=250; // ms between steps
var hasAccel=false, accelPermGranted=false;

function startAccelerometer(){
  if(typeof DeviceMotionEvent === 'undefined'){ hasAccel=false; return; }
  // iOS 13+ requires permission
  if(typeof DeviceMotionEvent.requestPermission === 'function'){
    DeviceMotionEvent.requestPermission().then(function(state){
      if(state==='granted'){ accelPermGranted=true; bindAccel(); }
      else { hasAccel=false; }
    }).catch(function(){ hasAccel=false; });
  } else {
    accelPermGranted=true;
    bindAccel();
  }
}

function bindAccel(){
  hasAccel=true;
  window.addEventListener('devicemotion', onDeviceMotion, true);
  toast('ğŸ“² Using accelerometer for step counting');
}

function onDeviceMotion(e){
  if(!tracking) return;
  var a=e.accelerationIncludingGravity;
  if(!a||a.x==null) return;
  var mag=Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z) - 9.8;
  // Low-pass filter
  accelAvg=accelAvg*0.8 + mag*0.2;
  var filtered=mag - accelAvg;
  var now=Date.now();
  if(filtered > STEP_THRESHOLD && (now - stepLastTime) > STEP_MIN_INTERVAL){
    stepLastTime=now;
    stepCount++;
    session.steps++;
    refreshStats();
  }
}

function stopAccelerometer(){
  window.removeEventListener('devicemotion', onDeviceMotion, true);
  hasAccel=false;
  accelAvg=0;
  accelBuffer=[];
}

// GPS-based step estimation (fallback / cross-check)
function estimateStepsFromDistance(distMeters){
  // Average stride length varies by speed. Walking ~0.76m, running ~1.2m
  var strideLen = currentSpeedKmh < 8 ? 0.76 : 1.2;
  return Math.round(distMeters / strideLen);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var COLORS=['#38bdf8','#4ade80','#f472b6','#fb923c','#a78bfa','#fbbf24','#f87171','#34d399'];
var colorIdx=0, me=null;
var session={steps:0, distance:0, calories:0, loops:0};
var todayStats={steps:0, distance:0, calories:0};

// Trail state
var trailCoords=[]; // [{lat,lng}] â€” current session path
var trailPolyline=null; // Leaflet polyline (glowy trail)
var trailGlowLine=null; // Wider glow behind
var closedLoopPolygons=[]; // array of Leaflet polygons
var loopCount=0;
var totalArea=0; // mÂ²

// Timing
var trackingStartTime=null, trackingTimerInterval=null;

// Speed
var currentSpeedKmh=0, speedHistory=[];

// GPS vars
var map, watchId, tracking=false, lastPos=null, smoothed=null, lastTs=null;
var markers={}, heatPts=[];
var GRID=0.00027, MIN_MOVE=5, MAX_SPD=15, SMOOTH=0.35;
var ACC_ACQUIRING=80, ACC_LOCKED=30, gpsLocked=false, firstFix=true;
var syncInterval, pollInterval;

function today(){ return new Date().toISOString().slice(0,10); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT â€” connect directly, no user setup needed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload=async function(){
  try{
    await sbSelect('users','select=id&limit=1');
    showAuth();
  } catch(e){
    document.getElementById('loading').style.display='none';
    document.getElementById('loading').innerHTML='<div style="color:#f87171;font-family:\'JetBrains Mono\',monospace;font-size:13px;text-align:center;padding:24px">âš ï¸ Could not connect to server.<br><span style="color:#4a5568;font-size:11px">Check your internet connection and try again.</span></div>';
    document.getElementById('loading').style.display='flex';
  }
};

function showAuth(){
  document.getElementById('loading').style.display='none';
  document.getElementById('auth').style.display='flex';
  buildSwatches(); loadUserList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePw(id,btn){
  var inp=document.getElementById(id);
  inp.type=inp.type==='password'?'text':'password';
  btn.textContent=inp.type==='password'?'ğŸ‘':'ğŸ™ˆ';
}
document.getElementById('tLogin').onclick=function(){
  document.getElementById('tLogin').className='tab on';
  document.getElementById('tRegister').className='tab';
  document.getElementById('pLogin').style.display='block';
  document.getElementById('pRegister').style.display='none';
};
document.getElementById('tRegister').onclick=function(){
  document.getElementById('tRegister').className='tab on';
  document.getElementById('tLogin').className='tab';
  document.getElementById('pRegister').style.display='block';
  document.getElementById('pLogin').style.display='none';
};

async function loadUserList(){
  var el=document.getElementById('ulist');
  el.innerHTML='<div class="empty">Loading...</div>';
  try{
    var users=await sbSelect('users','select=id,username,display,color&order=username');
    if(!users.length){ el.innerHTML='<div class="empty">No accounts yet â€” create one!</div>'; return; }
    el.innerHTML='';
    users.forEach(function(u){
      var row=document.createElement('div'); row.className='urow';
      row.innerHTML='<div class="av" style="background:'+u.color+'">'+u.display[0].toUpperCase()+'</div>'
        +'<div><div class="uname">'+u.display+'</div><div style="font-size:11px;color:#4a5568;font-family:\'JetBrains Mono\',monospace">@'+u.username+'</div></div>';
      row.onclick=function(){ document.getElementById('loginUser').value=u.username; document.getElementById('loginPass').focus(); };
      el.appendChild(row);
    });
  } catch(e){ el.innerHTML='<div class="empty">Could not load users</div>'; }
}

document.getElementById('btnLogin').onclick=async function(){
  var username=document.getElementById('loginUser').value.trim().toLowerCase();
  var pw=document.getElementById('loginPass').value;
  var err=document.getElementById('loginErr'); err.textContent='';
  if(!username||!pw){ err.textContent='Fill in username and password'; return; }
  this.textContent='Signing in...'; this.disabled=true;
  try{
    var hash=await hashPw(pw);
    var rows=await sbSelect('users','select=*&username=eq.'+encodeURIComponent(username)+'&password_hash=eq.'+encodeURIComponent(hash));
    if(!rows.length){ err.textContent='Wrong username or password'; this.textContent='SIGN IN â†’'; this.disabled=false; return; }
    me=rows[0]; await launchApp();
  } catch(e){ err.textContent='Error: '+e.message; this.textContent='SIGN IN â†’'; this.disabled=false; }
};

document.getElementById('btnCreate').onclick=async function(){
  var username=document.getElementById('inUser').value.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
  var display=document.getElementById('inName').value.trim();
  var pw=document.getElementById('inPass').value;
  var err=document.getElementById('regErr'); err.textContent='';
  if(username.length<2){ err.textContent='Username needs 2+ characters'; return; }
  if(!display){ err.textContent='Enter a display name'; return; }
  if(pw.length<4){ err.textContent='Password needs 4+ characters'; return; }
  this.textContent='Creating...'; this.disabled=true;
  try{
    var hash=await hashPw(pw);
    var rows=await sbInsert('users',{username:username,display:display,password_hash:hash,color:COLORS[colorIdx]});
    me=rows[0]; await launchApp();
  } catch(e){
    if(e.message.includes('unique')) err.textContent='Username already taken!';
    else err.textContent='Error: '+e.message;
    this.textContent='CREATE ACCOUNT â†’'; this.disabled=false;
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP LAUNCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function launchApp(){
  document.getElementById('auth').style.display='none';
  document.getElementById('app').style.display='flex';
  session={steps:0,distance:0,calories:0,loops:0};
  loopCount=0; totalArea=0; trailCoords=[];
  updateHeader();
  if(!map) initMap();
  await loadTodayStats();
  await loadTerritory();
  await loadLeaderboard();
  await loadHistory();
  pollInterval=setInterval(function(){ loadTerritory(); loadLeaderboard(); },15000);
  syncInterval=setInterval(syncStats,30000);
  setSyncStatus('ok','SYNCED');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap(){
  map=L.map('map',{zoomControl:true,attributionControl:false}).setView([20,0],3);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);
  map.on('click',function(e){
    if(!me||!tracking) return;
    smoothed={lat:e.latlng.lat,lng:e.latlng.lng};
    updateMarker(e.latlng.lat,e.latlng.lng);
    onPos(e.latlng.lat,e.latlng.lng,null);
    toast('ğŸ“ Position set manually');
    setBadge('live','Manual');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOWY TRAIL RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addTrailPoint(lat,lng){
  trailCoords.push([lat,lng]);

  // Remove and recreate polylines for glow effect
  if(trailGlowLine){ map.removeLayer(trailGlowLine); }
  if(trailPolyline){ map.removeLayer(trailPolyline); }

  if(trailCoords.length < 2) return;

  var c=me.color;

  // Outer glow (wide, transparent)
  trailGlowLine=L.polyline(trailCoords,{
    color:c, weight:18, opacity:0.08,
    lineCap:'round', lineJoin:'round'
  }).addTo(map);

  // Mid glow
  L.polyline(trailCoords,{
    color:c, weight:10, opacity:0.15,
    lineCap:'round', lineJoin:'round'
  }).addTo(map);

  // Core trail â€” bright and thin
  trailPolyline=L.polyline(trailCoords,{
    color:c, weight:3.5, opacity:0.95,
    lineCap:'round', lineJoin:'round'
  }).addTo(map);
}

function clearTrail(){
  if(trailGlowLine){ map.removeLayer(trailGlowLine); trailGlowLine=null; }
  if(trailPolyline){ map.removeLayer(trailPolyline); trailPolyline=null; }
  // Remove mid glow layers too (track them)
  trailCoords=[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOOP DETECTION & POLYGON SHADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
  Loop detection: when current position is within LOOP_CLOSE_DIST meters
  of the trail start (or any earlier point), and the trail has at least
  MIN_LOOP_POINTS points, we close the loop and fill the polygon.
  
  We also check against all earlier points (not just start) to handle
  figure-8 and self-intersecting paths.
*/
var LOOP_CLOSE_DIST=25; // meters â€” how close to "close" a loop
var MIN_LOOP_POINTS=8; // minimum points before loop can close
var loopHintShown=false;
var lastLoopCheckIdx=0;

function checkLoopClose(lat,lng){
  if(trailCoords.length < MIN_LOOP_POINTS) return;

  // Show hint when trail is getting long enough
  if(trailCoords.length > 15 && !loopHintShown){
    loopHintShown=true;
    var hint=document.getElementById('loop-hint');
    hint.style.display='block';
    setTimeout(function(){ hint.style.display='none'; },5000);
  }

  // Check distance to trail start point
  var start=trailCoords[0];
  var distToStart=haversine(lat,lng,start[0],start[1]);

  if(distToStart < LOOP_CLOSE_DIST && trailCoords.length > MIN_LOOP_POINTS){
    closeLoop();
    return;
  }

  // Check distance to any earlier point (at least MIN_LOOP_POINTS back from current)
  // This catches figure-8 loops
  var checkUntil=trailCoords.length - MIN_LOOP_POINTS;
  for(var i=lastLoopCheckIdx; i<checkUntil; i++){
    var d=haversine(lat,lng,trailCoords[i][0],trailCoords[i][1]);
    if(d < LOOP_CLOSE_DIST){
      // Close loop using points from i onwards
      var loopPoints=trailCoords.slice(i);
      loopPoints.push([lat,lng]);
      drawLoopPolygon(loopPoints);
      // Keep trail going but reset loop check
      lastLoopCheckIdx=trailCoords.length;
      celebrateLoop(polygonArea(loopPoints));
      break;
    }
  }
}

function closeLoop(){
  // Close the full current trail as a loop
  var loopPoints=trailCoords.slice();
  loopPoints.push(trailCoords[0]); // close it

  drawLoopPolygon(loopPoints);
  var area=polygonArea(loopPoints);
  celebrateLoop(area);

  // Start fresh trail from current position
  var lastPt=trailCoords[trailCoords.length-1];
  clearTrail();
  trailCoords=[lastPt];
  lastLoopCheckIdx=0;
  loopHintShown=false;
}

function drawLoopPolygon(coords){
  var c=me.color;
  var rgb=hexToRgb(c);
  var polygon=L.polygon(coords,{
    color:c,
    weight:2,
    opacity:0.8,
    fillColor:c,
    fillOpacity:0.18
  }).addTo(map);

  // Add player name label in the center of the polygon
  var center=polygonCentroid(coords);
  var label=L.divIcon({
    html:'<div style="font-family:\'Syne\',sans-serif;font-size:11px;font-weight:800;color:'+c+';text-shadow:0 0 8px '+c+',0 0 16px '+c+';white-space:nowrap;letter-spacing:1px;opacity:0.85">'+me.display+'</div>',
    className:'',
    iconAnchor:[0,0]
  });
  L.marker([center.lat,center.lng],{icon:label,interactive:false}).addTo(map);

  closedLoopPolygons.push(polygon);
}

function celebrateLoop(area){
  loopCount++;
  session.loops++;
  totalArea+=area;
  document.getElementById('sLoops').textContent=loopCount;
  document.getElementById('hudLoops').textContent=loopCount;
  document.getElementById('hudArea').textContent=formatArea(totalArea);

  // Big visual celebration
  var el=document.createElement('div');
  el.className='loop-celebrate';
  el.style.color=me.color;
  el.innerHTML='<div class="lc-title">ğŸ‰ LOOP CLOSED!</div>'
    +'<div class="lc-sub">+'+formatArea(area)+' CLAIMED</div>';
  document.body.appendChild(el);
  setTimeout(function(){ el.remove(); },2600);

  toast('ğŸ‰ Loop closed! +'+formatArea(area)+' territory');
}

function polygonArea(coords){
  // Shoelace formula in lat/lng converted to mÂ²
  var n=coords.length;
  if(n<3) return 0;
  var area=0;
  var R=6371000;
  for(var i=0;i<n;i++){
    var j=(i+1)%n;
    var xi=coords[i][1]*Math.PI/180 * R * Math.cos(coords[i][0]*Math.PI/180);
    var yi=coords[i][0]*Math.PI/180 * R;
    var xj=coords[j][1]*Math.PI/180 * R * Math.cos(coords[j][0]*Math.PI/180);
    var yj=coords[j][0]*Math.PI/180 * R;
    area+=xi*yj - xj*yi;
  }
  return Math.abs(area/2);
}

function polygonCentroid(coords){
  var lat=0,lng=0;
  coords.forEach(function(c){ lat+=c[0]; lng+=c[1]; });
  return {lat:lat/coords.length, lng:lng/coords.length};
}

function formatArea(m2){
  if(m2>=1000000) return (m2/1000000).toFixed(2)+'kmÂ²';
  if(m2>=10000) return (m2/10000).toFixed(1)+'ha';
  return Math.round(m2)+'mÂ²';
}

function hexToRgb(hex){
  var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return {r:r,g:g,b:b};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKEND DATA LOADERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTodayStats(){
  try{
    var rows=await sbSelect('daily_stats','select=*&user_id=eq.'+me.id+'&date=eq.'+today());
    if(rows.length) todayStats={steps:rows[0].steps,distance:rows[0].distance_m,calories:rows[0].calories};
    else todayStats={steps:0,distance:0,calories:0};
    refreshStats();
  } catch(e){ console.error('loadTodayStats',e); }
}

async function loadTerritory(){
  try{
    var rows=await sbSelect('territory','select=lat,lng,owner_id,owner_display,owner_color,intensity&limit=5000');
    heatPts=rows.map(function(r){ return{lat:+r.lat,lng:+r.lng,color:r.owner_color,display:r.owner_display,owner_id:r.owner_id,intensity:+r.intensity}; });
  } catch(e){ console.error('loadTerritory',e); }
}

async function loadLeaderboard(){
  try{
    var rows=await sbSelect('leaderboard','select=*');
    var medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    var el=document.getElementById('lb'); el.innerHTML='';
    rows.forEach(function(u,i){
      var row=document.createElement('div');
      row.className='lbrow'+(u.id===me.id?' me':'');
      row.innerHTML='<span class="lbrank">'+(medals[i]||i+1)+'</span>'
        +'<div class="lbav" style="background:'+u.color+'">'+u.display[0].toUpperCase()+'</div>'
        +'<span class="lbn">'+u.display+'</span>'
        +'<span class="lbs">'+u.zone_count+'</span>';
      el.appendChild(row);
    });
    var myRow=rows.find(function(r){ return r.id===me.id; });
    var tot=rows.reduce(function(s,r){ return s+(+r.zone_count); },0);
    var mine=myRow?(+myRow.zone_count):0;
    var pct=tot>0?((mine/tot)*100):0;
    document.getElementById('sPct').textContent=pct.toFixed(1)+'%';
    document.getElementById('sBar').style.width=Math.min(100,pct)+'%';
    document.getElementById('sZones').textContent=mine;
  } catch(e){ console.error('loadLeaderboard',e); }
}

async function loadHistory(){
  try{
    var rows=await sbSelect('daily_stats','select=date,steps,distance_m,calories&user_id=eq.'+me.id+'&order=date.desc&limit=7');
    var el=document.getElementById('histList'); el.innerHTML='';
    if(!rows.length){ el.innerHTML='<div class="empty">No history yet</div>'; return; }
    rows.forEach(function(r){
      var row=document.createElement('div'); row.className='hist-row';
      var dist=+r.distance_m>=1000?((+r.distance_m/1000).toFixed(1)+'km'):(Math.round(+r.distance_m)+'m');
      row.innerHTML='<span class="hist-date">'+r.date+'</span>'
        +'<div class="hist-vals"><span>'+Math.round(+r.steps).toLocaleString()+'ğŸ‘Ÿ</span><span>'+dist+'</span><span>'+Math.round(+r.calories)+'ğŸ”¥</span></div>';
      el.appendChild(row);
    });
  } catch(e){ console.error('loadHistory',e); }
}

async function syncStats(){
  if(session.steps===0 && session.distance===0) return;
  setSyncStatus('','SYNCING...');
  try{
    var rows=await sbSelect('daily_stats','select=id,steps,distance_m,calories&user_id=eq.'+me.id+'&date=eq.'+today());
    if(rows.length){
      await sbUpdate('daily_stats','id=eq.'+rows[0].id,{
        steps:rows[0].steps+session.steps,
        distance_m:+rows[0].distance_m+session.distance,
        calories:+rows[0].calories+session.calories
      });
    } else {
      await sbUpsert('daily_stats',{user_id:me.id,date:today(),steps:session.steps,distance_m:session.distance,calories:session.calories},'user_id,date');
    }
    todayStats.steps+=session.steps; todayStats.distance+=session.distance; todayStats.calories+=session.calories;
    session={steps:0,distance:0,calories:0,loops:session.loops};
    await loadHistory();
    setSyncStatus('ok','SYNCED');
  } catch(e){ console.error('syncStats',e); setSyncStatus('err','SYNC ERR'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GPS TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gpsErrMsg(code){
  if(code===1) return 'Location denied. Allow location in browser settings.';
  if(code===2) return 'Cannot find location. Go near a window or outdoors.';
  if(code===3) return 'GPS timed out. Try again.';
  return 'GPS error.';
}

document.getElementById('btnTrack').onclick=function(){ if(tracking) stopGPS(); else startGPS(); };

function startGPS(){
  if(!navigator.geolocation){ toast('Geolocation not supported'); return; }
  var btn=document.getElementById('btnTrack');
  btn.textContent='ğŸ›° Locating...'; btn.disabled=true;
  smoothed=null; lastPos=null; lastTs=null; gpsLocked=false; firstFix=true;
  setBadge('acquiring','LOCATING...');
  stepCount=0;
  session={steps:0,distance:0,calories:0,loops:0};
  clearTrail();
  closedLoopPolygons=[];
  loopCount=0; totalArea=0; loopHintShown=false; lastLoopCheckIdx=0;
  trackingStartTime=Date.now();

  // Start accelerometer for real step counting
  startAccelerometer();

  // Start HUD timer
  document.getElementById('trail-hud').style.display='block';
  document.getElementById('speed-hud').style.display='block';
  trackingTimerInterval=setInterval(updateHUD,1000);

  navigator.geolocation.getCurrentPosition(
    function(pos){ if(map) map.setView([pos.coords.latitude,pos.coords.longitude],17); updateMarker(pos.coords.latitude,pos.coords.longitude); },
    function(){},
    {enableHighAccuracy:true,timeout:8000,maximumAge:10000}
  );

  watchId=navigator.geolocation.watchPosition(
    function(pos){
      var acc=pos.coords.accuracy;
      var rlat=pos.coords.latitude,rlng=pos.coords.longitude,now=pos.timestamp;
      var spd=pos.coords.speed; // m/s, may be null

      if(acc<=ACC_LOCKED){ gpsLocked=true; setBadge('live','Â±'+Math.round(acc)+'m'); }
      else if(acc<=ACC_ACQUIRING){ setBadge('weak','Â±'+Math.round(acc)+'m...'); }
      else{ setBadge('weak','âš  Â±'+Math.round(acc)+'m'); }

      if(firstFix){
        firstFix=false; tracking=true;
        btn.className='mb stop'; btn.textContent='â¹ STOP'; btn.disabled=false;
        smoothed={lat:rlat,lng:rlng};
        updateMarker(rlat,rlng); map.setView([rlat,rlng],17);
      }

      var maxAcc=gpsLocked?ACC_LOCKED:ACC_ACQUIRING;
      if(acc>maxAcc){ updateMarker(rlat,rlng); return; }

      // Speed filter â€” reject if moving impossibly fast
      if(lastPos&&lastTs){
        var dt=(now-lastTs)/1000;
        if(dt>0&&haversine(lastPos.lat,lastPos.lng,rlat,rlng)/dt>MAX_SPD) return;
      }
      lastTs=now;

      // Smooth position
      if(!smoothed) smoothed={lat:rlat,lng:rlng};
      else{ smoothed.lat+=SMOOTH*(rlat-smoothed.lat); smoothed.lng+=SMOOTH*(rlng-smoothed.lng); }

      var lat=smoothed.lat,lng=smoothed.lng;
      updateMarker(lat,lng);

      // Only record movement if actually moved enough
      if(lastPos&&haversine(lastPos.lat,lastPos.lng,lat,lng)<MIN_MOVE) return;

      // Compute speed
      if(lastPos&&lastTs){
        var dSec=(now-lastTs)/1000;
        if(dSec>0){
          var dMeters=haversine(lastPos.lat,lastPos.lng,lat,lng);
          var speedMs=dMeters/dSec;
          currentSpeedKmh=speedMs*3.6;
          speedHistory.push(currentSpeedKmh);
          if(speedHistory.length>10) speedHistory.shift();
        }
      }

      // Use GPS speed if provided (more accurate)
      if(spd!=null && spd>=0) currentSpeedKmh=spd*3.6;

      onPos(lat,lng,now);
      map.panTo([lat,lng]);
    },
    function(err){
      btn.className='mb go'; btn.textContent='â–¶ START'; btn.disabled=false;
      tracking=false; setBadge('','READY');
      showGPSError(gpsErrMsg(err.code));
    },
    {enableHighAccuracy:true,maximumAge:2000,timeout:20000}
  );
}

function stopGPS(){
  if(watchId) navigator.geolocation.clearWatch(watchId);
  tracking=false; gpsLocked=false; firstFix=true; lastPos=null; smoothed=null; lastTs=null;
  document.getElementById('btnTrack').className='mb go';
  document.getElementById('btnTrack').textContent='â–¶ START';
  setBadge('','PAUSED');
  stopAccelerometer();
  clearInterval(trackingTimerInterval);
  document.getElementById('trail-hud').style.display='none';
  document.getElementById('speed-hud').style.display='none';
  document.getElementById('loop-hint').style.display='none';
  syncStats();
  toast('Tracking stopped');
}

function onPos(lat,lng,timestamp){
  var d=0;
  if(lastPos){
    d=haversine(lastPos.lat,lastPos.lng,lat,lng);
    session.distance+=d;
    session.calories+=(d/1000)*65; // ~65 cal/km (varies by weight/speed)

    // Step counting:
    // If accelerometer is active and counting, trust that.
    // If no accelerometer, estimate from GPS distance.
    if(!hasAccel){
      var estSteps=estimateStepsFromDistance(d);
      session.steps+=estSteps;
    }
    // If accelerometer IS active, session.steps is incremented in onDeviceMotion
  }
  lastPos={lat:lat,lng:lng};

  // Add to trail
  addTrailPoint(lat,lng);

  // Check for loop closure
  checkLoopClose(lat,lng);

  // Claim grid zone
  claimZone(Math.floor(lat/GRID)*GRID, Math.floor(lng/GRID)*GRID);

  refreshStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUD UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  if(!tracking) return;

  // Timer
  var elapsed=Math.floor((Date.now()-trackingStartTime)/1000);
  var mm=Math.floor(elapsed/60), ss=elapsed%60;
  document.getElementById('hudTime').textContent=(mm<10?'0':'')+mm+':'+(ss<10?'0':'')+ss;

  // Speed display
  var avgSpeed=speedHistory.length?speedHistory.reduce(function(a,b){return a+b;})/speedHistory.length:0;
  document.getElementById('speedVal').textContent=avgSpeed.toFixed(1);
  document.getElementById('sSpeed').textContent=avgSpeed.toFixed(1);

  // Pace (min/km)
  if(avgSpeed>0.5){
    var paceSecPerKm=3600/avgSpeed;
    var paceMin=Math.floor(paceSecPerKm/60), paceSec=Math.round(paceSecPerKm%60);
    document.getElementById('hudPace').textContent=paceMin+"'"+(paceSec<10?'0':'')+paceSec+'"';
  }

  // Cadence estimate (steps per minute)
  if(hasAccel && session.steps>0){
    var elapsed2=(Date.now()-trackingStartTime)/60000; // minutes
    var spm=elapsed2>0?Math.round(session.steps/elapsed2):0;
    document.getElementById('cadenceVal').textContent=spm+' spm';
  } else if(!hasAccel){
    document.getElementById('cadenceVal').textContent='GPS mode';
  }

  document.getElementById('hudLoops').textContent=loopCount;
  document.getElementById('hudArea').textContent=formatArea(totalArea);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateMarker(lat,lng){
  if(!me) return;
  if(!markers[me.id]){
    var icon=L.divIcon({
      html:'<div style="width:22px;height:22px;border-radius:50%;background:'+me.color+';border:3px solid rgba(255,255,255,0.9);box-shadow:0 0 18px '+me.color+',0 0 32px '+me.color+'80;position:relative">'
        +'<div style="position:absolute;inset:-6px;border-radius:50%;border:2px solid '+me.color+'40;animation:gp 1.4s infinite"></div>'
        +'</div>',
      className:'',iconSize:[22,22],iconAnchor:[11,11]
    });
    markers[me.id]=L.marker([lat,lng],{icon:icon,zIndexOffset:1000}).addTo(map);
  } else markers[me.id].setLatLng([lat,lng]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ZONE CLAIMING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function claimZone(lat,lng){
  var key=lat.toFixed(6)+','+lng.toFixed(6);
  var existing=heatPts.find(function(h){ return Math.abs(h.lat-lat)<0.000001&&Math.abs(h.lng-lng)<0.000001; });
  if(existing&&existing.owner_id===me.id){
    existing.intensity=Math.min(5,(existing.intensity||1)+0.2);
    try{ await sbUpdate('territory','grid_key=eq.'+encodeURIComponent(key),{intensity:existing.intensity}); } catch(e){}
    return;
  }
  if(existing&&existing.owner_id!==me.id){
    showConquest('âš”ï¸ Conquered!');
    var idx=heatPts.indexOf(existing); if(idx!==-1) heatPts.splice(idx,1);
  }
  try{
    await sbUpsert('territory',{grid_key:key,lat:lat,lng:lng,owner_id:me.id,owner_username:me.username,owner_display:me.display,owner_color:me.color,intensity:1,conquered_at:new Date().toISOString()},'grid_key');
    heatPts.push({lat:lat,lng:lng,color:me.color,display:me.display,owner_id:me.id,intensity:1});
  } catch(e){ console.error('claimZone',e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HAVERSINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haversine(a,b,c,d){
  var R=6371000,dL=(c-a)*Math.PI/180,dG=(d-b)*Math.PI/180;
  var x=Math.sin(dL/2)*Math.sin(dL/2)+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dG/2)*Math.sin(dG/2);
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHeader(){
  document.getElementById('hav').style.background=me.color;
  document.getElementById('hav').textContent=me.display[0].toUpperCase();
  document.getElementById('hname').textContent=me.display;
}

function refreshStats(){
  var steps=(todayStats.steps+session.steps);
  var dist=(todayStats.distance+session.distance);
  var cal=(todayStats.calories+session.calories);
  document.getElementById('sSteps').textContent=Math.round(steps).toLocaleString();
  document.getElementById('sDist').textContent=dist>=1000?(dist/1000).toFixed(2)+'km':Math.round(dist)+'m';
  document.getElementById('sCal').textContent=Math.round(cal);
  document.getElementById('sLoops').textContent=loopCount;
}

function setBadge(state,text){
  var b=document.getElementById('gpsbadge'),t=document.getElementById('gpstext');
  b.className='gpsbadge'+(state==='live'?' live':state==='weak'?' weak':'');
  t.textContent=text;
}
function setSyncStatus(state,text){
  var el=document.getElementById('syncStatus');
  el.textContent=text;
  el.className='syncing'+(state?' '+state:'');
}
function showGPSError(msg){
  var existing=document.getElementById('gpserr'); if(existing) existing.remove();
  var el=document.createElement('div'); el.id='gpserr';
  el.style.cssText='position:absolute;bottom:90px;left:50%;transform:translateX(-50%);background:rgba(13,16,23,0.97);border:1px solid rgba(248,113,113,0.4);border-radius:13px;padding:14px 20px;max-width:320px;text-align:center;z-index:600;font-size:13px;line-height:1.5;color:#fca5a5;font-family:\'JetBrains Mono\',monospace;box-shadow:0 8px 24px rgba(0,0,0,0.5)';
  el.innerHTML=msg+'<br><span style="color:#4a5568;font-size:11px;margin-top:6px;display:block">Or tap the map to place yourself manually</span>';
  document.getElementById('map').appendChild(el);
  setTimeout(function(){ if(el.parentNode) el.remove(); },8000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DROPDOWN / CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('hplayer').onclick=function(e){
  e.stopPropagation();
  var dd=document.getElementById('pdd');
  if(dd.classList.contains('open')){ dd.classList.remove('open'); return; }
  dd.innerHTML='';
  var back=document.createElement('div'); back.className='dda';
  back.textContent='â¬… Sign Out';
  back.onclick=function(){
    if(tracking) stopGPS();
    clearInterval(pollInterval); clearInterval(syncInterval);
    me=null;
    document.getElementById('app').style.display='none';
    document.getElementById('auth').style.display='flex';
    loadUserList();
    dd.classList.remove('open');
  };
  dd.appendChild(back);
  dd.classList.add('open');
};
document.addEventListener('click',function(){ document.getElementById('pdd').classList.remove('open'); });

document.getElementById('btnCenter').onclick=function(){
  if(!navigator.geolocation){ toast('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(
    function(p){ if(map) map.setView([p.coords.latitude,p.coords.longitude],17); },
    function(err){ toast(gpsErrMsg(err.code)); },
    {enableHighAccuracy:true,timeout:10000,maximumAge:5000}
  );
};

document.getElementById('btnReset').onclick=async function(){
  if(!confirm('Delete ALL territory data for everyone? Cannot be undone.')) return;
  try{
    await sbDelete('territory','id=gt.0');
    heatPts=[]; refreshStats(); await loadLeaderboard();
    clearTrail();
    closedLoopPolygons.forEach(function(p){ map.removeLayer(p); });
    closedLoopPolygons=[];
    toast('Territory reset');
  } catch(e){ toast('Reset failed: '+e.message); }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SWATCHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSwatches(){
  var el=document.getElementById('swatches'); el.innerHTML='';
  COLORS.forEach(function(c,i){
    var s=document.createElement('div');
    s.className='sw'+(i===colorIdx?' sel':'');
    s.style.background=c;
    s.onclick=function(){ colorIdx=i; document.querySelectorAll('.sw').forEach(function(x,j){ x.className='sw'+(j===i?' sel':''); }); };
    el.appendChild(s);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST & CONQUEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var toastT;
function toast(msg){ var t=document.getElementById('toast'); t.textContent=msg; t.className='on'; clearTimeout(toastT); toastT=setTimeout(function(){ t.className=''; },2800); }
function showConquest(msg){ var el=document.createElement('div'); el.className='cpop'; el.style.color=me.color; el.textContent=msg; document.body.appendChild(el); setTimeout(function(){ el.remove(); },1500); }
</script>
</body>
</html>
