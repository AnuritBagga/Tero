<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TerriTory DB Test</title>
<style>
body{font-family:monospace;background:#060810;color:#e2e8f5;padding:20px;font-size:13px}
h2{color:#38bdf8;margin-bottom:16px}
.test{margin-bottom:12px;padding:12px;border-radius:8px;border:1px solid #333}
.pass{border-color:#4ade80;background:rgba(74,222,128,0.08)}
.fail{border-color:#f87171;background:rgba(248,113,113,0.08)}
.pending{border-color:#374151;background:rgba(255,255,255,0.02)}
.label{font-weight:700;margin-bottom:4px}
.detail{color:#94a3b8;font-size:11px;word-break:break-all;margin-top:6px;white-space:pre-wrap}
button{background:linear-gradient(135deg,#38bdf8,#818cf8);color:#000;border:none;padding:12px 24px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:20px}
</style>
</head>
<body>
<h2>TerriTory — Live DB Diagnostic</h2>
<button onclick="runAll()">RUN ALL TESTS</button>
<div id="tests"></div>

<script>
var SB_URL = 'https://zvcpyvhnaahxsnoqycfr.supabase.co';
var SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2Y3B5dmhuYWFoeHNub3F5Y2ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTE0NjMsImV4cCI6MjA4NzE2NzQ2M30.wHMNZfjyYTzWZg0JjQ0fFjNmx7pt-YdG5Kxy2fWk5D0';
var H = {'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};

var tests = [];
var insertedId = null;

function addTest(name) {
  var div = document.createElement('div');
  div.className = 'test pending';
  div.innerHTML = '<div class="label">&#9679; ' + name + '</div><div class="detail" id="t'+tests.length+'">Running...</div>';
  document.getElementById('tests').appendChild(div);
  var idx = tests.length;
  tests.push({div:div, idx:idx});
  return idx;
}

function pass(idx, msg) {
  tests[idx].div.className = 'test pass';
  tests[idx].div.querySelector('.label').textContent = 'PASS: ' + tests[idx].div.querySelector('.label').textContent.slice(2);
  document.getElementById('t'+idx).textContent = msg;
}

function fail(idx, msg) {
  tests[idx].div.className = 'test fail';
  tests[idx].div.querySelector('.label').textContent = 'FAIL: ' + tests[idx].div.querySelector('.label').textContent.slice(2);
  document.getElementById('t'+idx).textContent = msg;
}

async function runAll() {
  document.getElementById('tests').innerHTML = '';
  tests = [];
  insertedId = null;

  // TEST 1: Can reach Supabase at all
  var t1 = addTest('Can reach Supabase URL');
  try {
    var r = await fetch(SB_URL + '/rest/v1/users?select=id&limit=1', {headers:H});
    var body = await r.text();
    if (r.ok) pass(t1, 'HTTP ' + r.status + ' — users table readable. Body: ' + body.slice(0,80));
    else fail(t1, 'HTTP ' + r.status + ' — ' + body);
  } catch(e) { fail(t1, 'Network error: ' + e.message); return; }

  // TEST 2: territories table exists
  var t2 = addTest('territories table exists');
  try {
    var r = await fetch(SB_URL + '/rest/v1/territories?select=id&limit=1', {headers:H});
    var body = await r.text();
    if (r.ok) pass(t2, 'HTTP ' + r.status + ' — territories readable. Rows: ' + body);
    else fail(t2, 'HTTP ' + r.status + ' — ' + body + '\n\nFIX: Run supabase_fix.sql in your Supabase SQL Editor!');
  } catch(e) { fail(t2, 'Error: ' + e.message); }

  // TEST 3: Can INSERT into territories
  var t3 = addTest('Can INSERT into territories');
  try {
    var testCoords = [[28.6,77.2],[28.601,77.2],[28.601,77.201],[28.6,77.2]];
    var payload = {
      owner_id: 1,
      owner_username: 'test_user',
      owner_display: 'Test User',
      owner_color: '#38bdf8',
      geojson: JSON.stringify(testCoords),
      area_m2: 999,
      created_at: new Date().toISOString()
    };
    var r = await fetch(SB_URL + '/rest/v1/territories', {
      method: 'POST',
      headers: Object.assign({}, H, {'Prefer':'return=representation'}),
      body: JSON.stringify(payload)
    });
    var body = await r.text();
    if (r.ok) {
      var inserted = JSON.parse(body);
      insertedId = inserted[0] && inserted[0].id;
      pass(t3, 'Inserted OK! id=' + insertedId + '\nFull response: ' + body.slice(0,200));
    } else {
      fail(t3, 'HTTP ' + r.status + '\nError: ' + body + '\n\nPossible causes:\n- owner_id=1 doesnt exist in users table (need real user id)\n- RLS policy blocking insert\n- territories table doesnt exist');
    }
  } catch(e) { fail(t3, 'Error: ' + e.message); }

  // TEST 4: Can READ back what we inserted
  var t4 = addTest('Can READ territories back');
  try {
    var r = await fetch(SB_URL + '/rest/v1/territories?select=*&order=created_at.desc&limit=5', {headers:H});
    var body = await r.text();
    if (r.ok) {
      var rows = JSON.parse(body);
      pass(t4, 'Found ' + rows.length + ' rows in territories table.\n' + body.slice(0,300));
    } else {
      fail(t4, 'HTTP ' + r.status + ' — ' + body);
    }
  } catch(e) { fail(t4, 'Error: ' + e.message); }

  // TEST 5: Check actual users in DB (to see real owner_id)
  var t5 = addTest('List users (to get real IDs)');
  try {
    var r = await fetch(SB_URL + '/rest/v1/users?select=id,username,display&limit=10', {headers:H});
    var body = await r.text();
    if (r.ok) {
      pass(t5, 'Users in DB: ' + body);
    } else {
      fail(t5, 'HTTP ' + r.status + ' — ' + body);
    }
  } catch(e) { fail(t5, 'Error: ' + e.message); }

  // TEST 6: Clean up test row
  if (insertedId) {
    var t6 = addTest('Cleanup test row (DELETE id=' + insertedId + ')');
    try {
      var r = await fetch(SB_URL + '/rest/v1/territories?id=eq.' + insertedId, {
        method: 'DELETE', headers: H
      });
      if (r.ok || r.status === 204) pass(t6, 'Deleted test row OK');
      else fail(t6, 'HTTP ' + r.status + ' — ' + await r.text());
    } catch(e) { fail(t6, 'Error: ' + e.message); }
  }
}
</script>
</body>
</html>
