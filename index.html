<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TerriTory DB Test v2</title>
<style>
body{font-family:monospace;background:#060810;color:#e2e8f5;padding:20px;font-size:13px}
h2{color:#38bdf8;margin-bottom:4px}
.sub{color:#374151;font-size:11px;margin-bottom:16px}
.test{margin-bottom:10px;padding:12px;border-radius:8px;border:1px solid #333}
.pass{border-color:#4ade80;background:rgba(74,222,128,0.08)}
.fail{border-color:#f87171;background:rgba(248,113,113,0.08)}
.run{border-color:#374151;background:rgba(255,255,255,0.02)}
.label{font-weight:700;margin-bottom:5px;font-size:13px}
.detail{color:#94a3b8;font-size:11px;word-break:break-all;white-space:pre-wrap;margin-top:4px}
button{background:linear-gradient(135deg,#38bdf8,#818cf8);color:#000;border:none;padding:12px 28px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:20px}
</style>
</head>
<body>
<h2>TerriTory — DB Test v2</h2>
<div class="sub">Tests against your live Supabase database</div>
<button onclick="runAll()">RUN ALL TESTS</button>
<div id="out"></div>
<script>
var URL = 'https://zvcpyvhnaahxsnoqycfr.supabase.co';
var KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2Y3B5dmhuYWFoeHNub3F5Y2ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTE0NjMsImV4cCI6MjA4NzE2NzQ2M30.wHMNZfjyYTzWZg0JjQ0fFjNmx7pt-YdG5Kxy2fWk5D0';
var H = {'Content-Type':'application/json','apikey':KEY,'Authorization':'Bearer '+KEY};

var out, results=[], testId=null;

function addRow(label){
  var d=document.createElement('div'); d.className='test run';
  var id='t'+results.length;
  d.innerHTML='<div class="label">... '+label+'</div><div class="detail" id="'+id+'">waiting...</div>';
  out.appendChild(d);
  results.push({el:d,id:id,label:label});
  return results.length-1;
}
function pass(i,msg){ results[i].el.className='test pass'; results[i].el.querySelector('.label').textContent='PASS: '+results[i].label; document.getElementById(results[i].id).textContent=msg; }
function fail(i,msg){ results[i].el.className='test fail'; results[i].el.querySelector('.label').textContent='FAIL: '+results[i].label; document.getElementById(results[i].id).textContent=msg; }

async function runAll(){
  out=document.getElementById('out'); out.innerHTML=''; results=[]; testId=null;

  // TEST 1 — reach Supabase
  var t1=addRow('Supabase connection');
  try{
    var r=await fetch(URL+'/rest/v1/users?select=id&limit=1',{headers:H});
    var b=await r.text();
    if(r.ok) pass(t1,'OK — status '+r.status);
    else fail(t1,'HTTP '+r.status+' — '+b);
  }catch(e){fail(t1,'Network error: '+e.message);return;}

  // TEST 2 — users table readable
  var t2=addRow('users table — list all');
  try{
    var r=await fetch(URL+'/rest/v1/users?select=id,username,display',{headers:H});
    var b=await r.text();
    if(r.ok){ var rows=JSON.parse(b); pass(t2,'Found '+rows.length+' users:\n'+b); }
    else fail(t2,'HTTP '+r.status+' — '+b);
  }catch(e){fail(t2,''+e);}

  // TEST 3 — territories table readable
  var t3=addRow('territories table — exists and readable');
  try{
    var r=await fetch(URL+'/rest/v1/territories?select=id,owner_display,area_m2&limit=10',{headers:H});
    var b=await r.text();
    if(r.ok){ var rows=JSON.parse(b); pass(t3,'Table exists! Found '+rows.length+' rows:\n'+b); }
    else fail(t3,'HTTP '+r.status+'\n'+b+'\n\nThe territories table does not exist. Run the reset SQL again.');
  }catch(e){fail(t3,''+e);}

  // TEST 4 — insert into territories with fake UUID owner_id
  var t4=addRow('INSERT into territories');
  try{
    var fakeId='00000000-0000-0000-0000-000000000001';
    var coords=[[28.6,77.2],[28.601,77.2],[28.601,77.201],[28.6,77.2]];
    var payload={
      owner_id:fakeId,
      owner_username:'dbtest',
      owner_display:'DB Test',
      owner_color:'#38bdf8',
      geojson:JSON.stringify(coords),
      area_m2:1234,
      created_at:new Date().toISOString()
    };
    var r=await fetch(URL+'/rest/v1/territories',{
      method:'POST',
      headers:Object.assign({},H,{'Prefer':'return=representation'}),
      body:JSON.stringify(payload)
    });
    var b=await r.text();
    if(r.ok){
      var inserted=JSON.parse(b);
      testId=inserted[0]&&inserted[0].id;
      pass(t4,'INSERT worked! New row id='+testId+'\n'+b);
    } else {
      fail(t4,'HTTP '+r.status+'\n'+b);
    }
  }catch(e){fail(t4,''+e);}

  // TEST 5 — read back
  var t5=addRow('READ territories back');
  try{
    var r=await fetch(URL+'/rest/v1/territories?select=*&order=created_at.desc&limit=5',{headers:H});
    var b=await r.text();
    if(r.ok){ var rows=JSON.parse(b); pass(t5,'Read OK — '+rows.length+' rows:\n'+b.slice(0,400)); }
    else fail(t5,'HTTP '+r.status+' — '+b);
  }catch(e){fail(t5,''+e);}

  // TEST 6 — daily_stats table
  var t6=addRow('daily_stats table — exists');
  try{
    var r=await fetch(URL+'/rest/v1/daily_stats?select=id&limit=1',{headers:H});
    var b=await r.text();
    if(r.ok) pass(t6,'OK — '+b);
    else fail(t6,'HTTP '+r.status+' — '+b);
  }catch(e){fail(t6,''+e);}

  // TEST 7 — cleanup
  if(testId){
    var t7=addRow('DELETE test row (cleanup)');
    try{
      var r=await fetch(URL+'/rest/v1/territories?id=eq.'+testId,{method:'DELETE',headers:H});
      if(r.ok||r.status===204) pass(t7,'Deleted test row id='+testId);
      else fail(t7,'HTTP '+r.status+' — '+await r.text());
    }catch(e){fail(t7,''+e);}
  }
}
</script>
</body>
</html>
